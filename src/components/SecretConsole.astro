---
// SecretConsole.astro â€” The Hidden Pro Console
// Press ` (backtick) to summon | Type a code | Press Enter | ðŸ¤«
// Mobile: triple-tap the footer quote to open
---

<!-- Console Input -->
<div class="fixed bottom-6 inset-x-0 flex justify-center z-[9999] pointer-events-none">
  <div id="secret-console" style="opacity:0; transform:translateY(80px); pointer-events:none;">
    <div id="console-box" class="flex items-center gap-2 px-4 py-2.5 rounded-xl border border-accent/30 bg-surface/95 shadow-lg shadow-accent/10"
         style="backdrop-filter:blur(20px);">
      <span class="text-accent font-mono text-sm select-none animate-pulse">&gt;_</span>
      <input id="secret-input" type="text"
             class="bg-transparent outline-none text-text font-mono text-sm w-56 placeholder:text-text-muted/30"
             style="border:none;"
             placeholder="enter secret code..." autocomplete="off" spellcheck="false" />
      <kbd class="hidden sm:inline text-[9px] text-text-muted/30 font-mono border border-text-muted/10 rounded px-1 py-0.5 select-none">ESC</kbd>
    </div>
  </div>
</div>

<!-- Pro Mode Badge -->
<div id="pro-badge" class="fixed top-20 right-4 z-[9998]"
     style="opacity:0; transform:translateX(80px);">
  <div class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-accent/20 bg-surface/80"
       style="backdrop-filter:blur(10px);">
    <span class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></span>
    <span class="text-[10px] font-mono text-accent uppercase tracking-widest font-bold">Pro Mode</span>
  </div>
</div>

<!-- Effect Overlay -->
<div id="egg-overlay" class="fixed inset-0 z-[9997] pointer-events-none flex items-center justify-center"
     style="opacity:0;">
  <div id="egg-message" class="relative text-center px-8 max-w-3xl"></div>
</div>

<!-- Particle Canvas -->
<canvas id="egg-canvas" class="fixed inset-0 z-[9996] pointer-events-none" style="opacity:0;"></canvas>

<script>
  import { gsap } from 'gsap';

  (function initSecretConsole() {
    // --- Elements ---
    const consoleEl = document.getElementById('secret-console') as HTMLElement;
    const consoleBox = document.getElementById('console-box') as HTMLElement;
    const input = document.getElementById('secret-input') as HTMLInputElement;
    const overlay = document.getElementById('egg-overlay') as HTMLElement;
    const msgEl = document.getElementById('egg-message') as HTMLElement;
    const badge = document.getElementById('pro-badge') as HTMLElement;
    const canvas = document.getElementById('egg-canvas') as HTMLCanvasElement;
    const ctx = canvas.getContext('2d')!;

    let isOpen = false;
    let proMode = false;
    let busy = false;

    // --- Console Toggle ---
    document.addEventListener('keydown', (e) => {
      if (e.key === '`' && !isOpen && !busy) {
        e.preventDefault();
        openConsole();
      } else if (e.key === 'Escape' && isOpen) {
        closeConsole();
      }
    });

    // Mobile: triple-tap footer quote
    let tapCount = 0;
    let tapTimer: number;
    const footer = document.querySelector('footer');
    footer?.addEventListener('click', () => {
      tapCount++;
      clearTimeout(tapTimer);
      tapTimer = window.setTimeout(() => { tapCount = 0; }, 600);
      if (tapCount >= 3) {
        tapCount = 0;
        if (!isOpen && !busy) openConsole();
      }
    });

    // Input handling
    input.addEventListener('keydown', (e) => {
      if (e.key === '`') e.preventDefault();
      if (e.key === 'Enter') {
        const code = input.value.trim().toUpperCase();
        input.value = '';
        if (code && EGGS[code]) {
          fireEgg(code);
        } else if (code) {
          // Wrong code â€” shake the console box
          gsap.to(consoleBox, {
            x: -6, duration: 0.04, repeat: 7, yoyo: true,
            ease: 'none', onComplete: () => gsap.set(consoleBox, { x: 0 }),
          });
        }
      }
    });

    function openConsole() {
      isOpen = true;
      gsap.to(consoleEl, { y: 0, opacity: 1, duration: 0.4, ease: 'back.out(2)' });
      consoleEl.style.pointerEvents = 'auto';
      input.focus();
    }

    function closeConsole() {
      isOpen = false;
      gsap.to(consoleEl, { y: 80, opacity: 0, duration: 0.25, ease: 'power2.in' });
      consoleEl.style.pointerEvents = 'none';
      input.value = '';
      input.blur();
    }

    function enableProMode() {
      if (proMode) return;
      proMode = true;
      gsap.to(badge, { opacity: 1, x: 0, duration: 0.6, ease: 'back.out(2)' });
    }

    function fireEgg(code: string) {
      if (busy) return;
      busy = true;
      closeConsole();
      enableProMode();
      EGGS[code](() => { busy = false; });
    }

    // --- Helpers ---
    function pick<T>(arr: T[]): T { return arr[Math.floor(Math.random() * arr.length)]; }

    function styledText(text: string, color: string, size = '4rem', extra = '') {
      return `<p style="font-size:${size}; font-weight:900; color:${color}; font-family:'Inter',sans-serif; letter-spacing:-0.02em; line-height:1.2; ${extra}">${text}</p>`;
    }

    function subtitle(text: string, color: string, extra = '') {
      return `<p style="font-size:1.1rem; color:${color}; margin-top:0.5rem; font-family:'Inter',sans-serif; ${extra}">${text}</p>`;
    }

    // --- Effect Engine ---
    function showEffect(opts: {
      bg: string;
      html: string;
      shake?: boolean;
      duration?: number;
      particles?: { count: number; colors: string[]; style: 'sparks' | 'confetti' };
    }, done: () => void) {
      const dur = opts.duration || 3500;

      overlay.style.background = opts.bg;
      msgEl.innerHTML = opts.html;

      gsap.to(overlay, { opacity: 1, duration: 0.3 });
      gsap.fromTo(msgEl,
        { scale: 0.2, rotation: -10, opacity: 0 },
        { scale: 1, rotation: 0, opacity: 1, duration: 0.7, ease: 'back.out(1.7)', delay: 0.15 },
      );

      if (opts.shake) {
        gsap.to(document.body, {
          x: -6, duration: 0.04, repeat: 9, yoyo: true,
          ease: 'none', onComplete: () => gsap.set(document.body, { x: 0 }),
        });
      }

      if (opts.particles) spawnParticles(opts.particles, dur);

      setTimeout(() => {
        gsap.to(overlay, {
          opacity: 0, duration: 0.6,
          onComplete: () => { msgEl.innerHTML = ''; done(); },
        });
      }, dur);
    }

    // --- Particle System ---
    interface Particle {
      x: number; y: number; vx: number; vy: number;
      size: number; color: string; alpha: number;
      rotation: number; rotSpeed: number; shape: 'rect' | 'circle';
    }

    function spawnParticles(opts: { count: number; colors: string[]; style: 'sparks' | 'confetti' }, duration: number) {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      gsap.to(canvas, { opacity: 1, duration: 0.2 });

      const cx = canvas.width / 2;
      const cy = canvas.height / 2;
      const particles: Particle[] = [];

      for (let i = 0; i < opts.count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = opts.style === 'sparks' ? Math.random() * 12 + 4 : Math.random() * 3 + 1;
        particles.push({
          x: opts.style === 'sparks' ? cx : Math.random() * canvas.width,
          y: opts.style === 'sparks' ? cy : -20,
          vx: opts.style === 'sparks' ? Math.cos(angle) * speed : (Math.random() - 0.5) * 2,
          vy: opts.style === 'sparks' ? Math.sin(angle) * speed : Math.random() * 3 + 2,
          size: opts.style === 'confetti' ? Math.random() * 8 + 3 : Math.random() * 3 + 1,
          color: opts.colors[Math.floor(Math.random() * opts.colors.length)],
          alpha: 1,
          rotation: Math.random() * 360,
          rotSpeed: (Math.random() - 0.5) * 8,
          shape: opts.style === 'confetti' ? 'rect' : 'circle',
        });
      }

      let animId: number;
      function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let alive = false;

        for (const p of particles) {
          p.x += p.vx;
          p.vy += 0.12;
          p.y += p.vy;
          p.vx *= 0.99;
          p.rotation += p.rotSpeed;
          p.alpha -= 0.006;

          if (p.alpha <= 0 || p.y > canvas.height + 20) continue;
          alive = true;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate((p.rotation * Math.PI) / 180);
          ctx.globalAlpha = Math.max(0, p.alpha);
          ctx.fillStyle = p.color;

          if (p.shape === 'rect') {
            ctx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size / 2);
          } else {
            ctx.beginPath();
            ctx.arc(0, 0, p.size, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.restore();
        }

        if (alive) {
          animId = requestAnimationFrame(loop);
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          canvas.style.opacity = '0';
        }
      }

      loop();

      setTimeout(() => {
        cancelAnimationFrame(animId);
        gsap.to(canvas, {
          opacity: 0, duration: 0.5,
          onComplete: () => ctx.clearRect(0, 0, canvas.width, canvas.height),
        });
      }, duration);
    }

    // =============================================
    //  ðŸŽ® EASTER EGGS REGISTRY
    // =============================================

    const EGGS: Record<string, (done: () => void) => void> = {

      // -------- ðŸ¤¼ CM PUNK --------
      'CMPUNK': (done) => showEffect({
        bg: 'rgba(0,0,0,0.92)',
        html: styledText(
          pick(["IT'S CLOBBERIN' TIME! ðŸ’ª", "Best in the World. ðŸ†", "I am the voice of the voiceless. ðŸŽ¤"]),
          '#FFD700', '3.5rem',
          'text-shadow: 0 0 30px #FFD700, 0 0 60px #FFD700;',
        ),
        shake: true,
        particles: { count: 80, colors: ['#FFD700', '#FFA500', '#FF6B00', '#FFFFFF'], style: 'sparks' },
      }, done),

      // -------- ðŸ’¤ GTS (Go To Sleep) --------
      'GTS': (done) => {
        overlay.style.background = '#000';
        msgEl.innerHTML = '';
        gsap.to(overlay, {
          opacity: 1, duration: 1.5, ease: 'power2.in',
          onComplete: () => {
            msgEl.innerHTML = styledText('ðŸ’¤ Go To Sleep...', '#999', '3rem', 'text-shadow: 0 0 15px rgba(153,153,153,0.4);');
            gsap.fromTo(msgEl, { opacity: 0 }, { opacity: 1, duration: 1 });
            setTimeout(() => {
              overlay.style.background = '#fff';
              setTimeout(() => {
                gsap.to(overlay, {
                  opacity: 0, duration: 0.8,
                  onComplete: () => { msgEl.innerHTML = ''; done(); },
                });
              }, 150);
            }, 2000);
          },
        });
      },

      // -------- ðŸ’£ PIPEBOMB --------
      'PIPEBOMB': (done) => showEffect({
        bg: 'rgba(20,0,0,0.95)',
        html: '<p style="font-size:4rem; margin-bottom:0.5rem;">ðŸŽ¤</p>' +
              styledText(
                pick(["This is a PIPE BOMB!", "You want change? I AM the change.", "I'm the best wrestler in the world."]),
                '#FF6B6B', '2.5rem',
                'text-shadow: 0 0 20px #FF0000, 0 0 40px rgba(255,0,0,0.4);',
              ),
        shake: true,
        particles: { count: 100, colors: ['#FF3333', '#FF6600', '#FFD700', '#FF0000'], style: 'sparks' },
        duration: 4000,
      }, done),

      // -------- âš¡ BEST IN THE WORLD --------
      'BESTINTHEWORLD': (done) => {
        // White flash â†’ proclamation
        overlay.style.background = '#fff';
        gsap.to(overlay, {
          opacity: 1, duration: 0.05,
          onComplete: () => {
            gsap.to(overlay, {
              opacity: 0, duration: 0.15,
              onComplete: () => {
                showEffect({
                  bg: 'rgba(0,0,0,0.95)',
                  html: styledText('âš¡ BEST IN THE WORLD âš¡', '#FFFFFF', '3.5rem',
                    'text-shadow: 0 0 20px #fff, 0 0 40px #FFD700, 0 0 80px #FFD700; animation: egg-glow-pulse 1s ease-in-out infinite;'),
                  particles: { count: 60, colors: ['#FFFFFF', '#FFD700', '#FFF8DC'], style: 'sparks' },
                  duration: 3500,
                }, done);
              },
            });
          },
        });
      },

      // -------- ðŸ† UNIVERSITARIO / CREMA --------
      'CREMA': (done) => showEffect({
        bg: 'rgba(180,30,0,0.9)',
        html: styledText('Â¡DALE U! ðŸ†', '#FCF0C8', '4rem',
                'text-shadow: 0 0 20px rgba(252,240,200,0.5);') +
              subtitle('Universitario de Deportes â€” El mÃ¡s grande del PerÃº', '#FCF0C8'),
        particles: { count: 80, colors: ['#FCF0C8', '#D40000', '#FFFFFF', '#FFD700'], style: 'confetti' },
        duration: 4000,
      }, done),

      // -------- ðŸ MESSI / D10S --------
      'MESSI': (done) => showEffect({
        bg: 'linear-gradient(135deg, rgba(0,40,104,0.95), rgba(0,20,60,0.95))',
        html: styledText('D10S ðŸ', '#FFD700', '5rem',
                'text-shadow: 0 0 30px #FFD700, 0 0 60px rgba(255,215,0,0.5);') +
              subtitle('The Greatest of All Time', '#FFD700'),
        particles: { count: 100, colors: ['#FFD700', '#FFA500', '#FFFACD', '#DAA520'], style: 'confetti' },
        duration: 4000,
      }, done),

      // -------- ðŸ”µðŸ”´ BARCELONA --------
      'BARCA': (done) => showEffect({
        bg: 'linear-gradient(135deg, rgba(0,48,135,0.97), rgba(163,0,51,0.97))',
        html: styledText('MÃ©s que un club', '#FFFFFF', '3.5rem',
                'font-style:italic; text-shadow: 0 0 20px rgba(255,255,255,0.5);') +
              '<p style="font-size:2.5rem; margin-top:0.5rem;">ðŸ”µðŸ”´</p>',
        particles: { count: 70, colors: ['#004D98', '#A30033', '#FFD700', '#FFFFFF'], style: 'confetti' },
      }, done),

      // -------- ðŸ‡µðŸ‡ª PERÃš --------
      'PERU': (done) => showEffect({
        bg: 'linear-gradient(180deg, rgba(217,16,35,0.97), rgba(255,255,255,0.97), rgba(217,16,35,0.97))',
        html: styledText('Â¡ARRIBA PERÃš! ðŸ‡µðŸ‡ª', '#FFFFFF', '3.5rem',
                'text-shadow: 2px 2px 8px rgba(0,0,0,0.6), 0 0 20px rgba(217,16,35,0.5); -webkit-text-stroke: 1px rgba(180,0,0,0.3);'),
        particles: { count: 90, colors: ['#D91023', '#FFFFFF', '#FFD700'], style: 'confetti' },
        duration: 4000,
      }, done),

      // -------- âš”ï¸ STAR WARS / FORCE --------
      'FORCE': (done) => showEffect({
        bg: 'rgba(0,0,0,0.95)',
        html: '<div style="width:60%;max-width:400px;height:3px;background:linear-gradient(90deg,transparent,#00ff41,#00ff41,transparent);margin:0 auto 1.5rem;box-shadow:0 0 20px #00ff41,0 0 40px #00ff41,0 0 80px #00ff41;border-radius:2px;"></div>' +
              styledText(
                pick(["The Force is strong with this one.", "Do. Or do not. There is no try.", "This is the way.", "May the deploy be with you. âš”ï¸"]),
                '#00ff41', '2.5rem',
                'text-shadow: 0 0 15px #00ff41, 0 0 30px rgba(0,255,65,0.3);',
              ),
        particles: { count: 40, colors: ['#00ff41', '#00cc33', '#66ff99', '#003300'], style: 'sparks' },
        duration: 4000,
      }, done),
    };

    // --- Aliases ---
    EGGS['UNIVERSITARIO'] = EGGS['CREMA'];
    EGGS['D10S'] = EGGS['MESSI'];
    EGGS['GOAT'] = EGGS['MESSI'];
    EGGS['BARCELONA'] = EGGS['BARCA'];
    EGGS['BICOLOR'] = EGGS['PERU'];
    EGGS['STARWARS'] = EGGS['FORCE'];
    EGGS['JEDI'] = EGGS['FORCE'];

    // =============================================
    //  ðŸ•¹ï¸ KONAMI CODE (â†‘â†‘â†“â†“â†â†’â†â†’BA)
    // =============================================
    const KONAMI = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let kIndex = 0;

    document.addEventListener('keydown', (e) => {
      if (isOpen) return; // don't capture while typing in console
      if (e.key === KONAMI[kIndex]) {
        kIndex++;
        if (kIndex === KONAMI.length) {
          kIndex = 0;
          if (!busy) {
            busy = true;
            enableProMode();
            showEffect({
              bg: 'linear-gradient(135deg, #ff0000, #ff8800, #ffff00, #00ff00, #0088ff, #8800ff)',
              html: styledText('ðŸŽ® KONAMI CODE! ðŸ•¹ï¸', '#FFFFFF', '3rem',
                      'text-shadow: 2px 2px 6px rgba(0,0,0,0.7), 0 0 20px #fff, 0 0 40px #fff;') +
                    subtitle('â†‘â†‘â†“â†“â†â†’â†â†’BA â€” You found the ultimate secret!', '#FFFFFF', 'text-shadow: 1px 1px 4px rgba(0,0,0,0.6);'),
              particles: { count: 150, colors: ['#ff0000','#ff8800','#ffff00','#00ff00','#0088ff','#8800ff','#ff00ff'], style: 'confetti' },
              duration: 5000,
            }, () => { busy = false; });
          }
        }
      } else {
        kIndex = e.key === KONAMI[0] ? 1 : 0;
      }
    });

  })();
</script>
